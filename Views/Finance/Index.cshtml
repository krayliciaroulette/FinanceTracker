@{
    ViewData["Title"] = "Dashboard";
    Layout = "_FinanceLayout";
}

<div class="fade-in-up">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6 m-0">Dashboard Overview</h1>
        <div class="text-muted">@ViewBag.CurrentMonth</div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);">
                <div class="card-body text-center p-4">
                    <h6 class="text-white-50 mb-2">Total Budget</h6>
                    <h2 class="fw-bold text-white mb-0">₱@String.Format("{0:N2}", ViewBag.TotalBudgets)</h2>
                    <small class="text-white-50">This Month</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);">
                <div class="card-body text-center p-4">
                    <h6 class="text-white-50 mb-2">Total Spent</h6>
                    <h2 class="fw-bold text-white mb-0">₱@String.Format("{0:N2}", ViewBag.TotalMonthlyExpenses)</h2>
                    <small class="text-white-50">This Month</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                <div class="card-body text-center p-4">
                    <h6 class="text-white-50 mb-2">Remaining</h6>
                    <h2 class="fw-bold text-white mb-0">₱@String.Format("{0:N2}", ViewBag.Remaining)</h2>
                    <small class="text-white-50">Available Budget</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <span>Budget Usage by Category</span>
                </div>
                <div class="card-body">
                    <div style="height: 320px; position: relative;">
                        <canvas id="budgetBarGraph"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <span>Daily Expense Breakdown</span>
                </div>
                <div class="card-body">
                    <div style="height: 320px; position: relative;">
                        <canvas id="expensePieGraph"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Expenses Section -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span>Today's Expenses</span>
                @if (ViewBag.TodayExpenses != null && ((List<ExpenseTracker.Models.Expense>)ViewBag.TodayExpenses).Any())
                {
                    <span class="text-muted">@(((List<ExpenseTracker.Models.Expense>)ViewBag.TodayExpenses).Count) items</span>
                }
            </div>
        </div>
        <div class="card-body p-0">
            @if (ViewBag.TodayExpenses == null || !((List<ExpenseTracker.Models.Expense>)ViewBag.TodayExpenses).Any())
            {
                <div class="text-center py-5">
                    <div class="text-muted mb-3" style="font-size: 3rem; opacity: 0.3;">—</div>
                    <h5 class="text-muted">No expenses today</h5>
                    <p class="text-secondary small">You haven't recorded any expenses yet today</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Category</th>
                                <th style="width: 15%;" class="text-end">Amount</th>
                                <th style="width: 45%;">Description</th>
                                <th style="width: 20%;">Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in (List<ExpenseTracker.Models.Expense>)ViewBag.TodayExpenses)
                            {
                                <tr>
                                    <td>
                                        <span class="badge bg-primary">@item.DisplayCategoryName</span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-danger">₱@item.Amount.ToString("N2")</strong>
                                    </td>
                                    <td>@item.Description</td>
                                    <td>
                                        @{
                                            var phTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Singapore Standard Time");
                                            var phDate = TimeZoneInfo.ConvertTime(item.ExpenseDate, phTimeZone);
                                        }
                                        <small class="text-muted">@phDate.ToString("hh:mm tt")</small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-active">
                            <tr>
                                <td colspan="1"><strong class="text-white">Total Expenses For Today</strong></td>
                                <td class="text-end"><strong class="text-white">₱@ViewBag.TotalExpenses.ToString("N2")</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    // Budget Bar Graph with Over Budget Badges
    const budgetData = @Html.Raw(ViewBag.BudgetChartData ?? "[]");

    const budgetCtx = document.getElementById('budgetBarGraph').getContext('2d');

    // ✅ Calculate over-budget amounts
    const overBudgetAmounts = budgetData.map(b => {
        const total = b.Spent + b.Remaining;
        return b.Spent > total ? b.Spent - total : 0;
    });

    new Chart(budgetCtx, {
        type: 'bar',
        data: {
            labels: budgetData.map(b => b.CategoryName),
            datasets: [
                {
                    label: 'Remaining',
                    data: budgetData.map(b => Math.max(b.Remaining, 0)),
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderRadius: 6
                },
                {
                    label: 'Spent',
                    data: budgetData.map(b => {
                        const total = b.Spent + b.Remaining;
                        return Math.min(b.Spent, total);
                    }),
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true,
                    ticks: { color: '#ffffff' },
                    grid: { display: false }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff',
                        callback: value => '₱' + value.toLocaleString()
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#ffffff', font: { size: 12 } }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    callbacks: {
                        label: ctx => ctx.dataset.label + ': ₱' + ctx.raw.toLocaleString(),
                        afterLabel: (ctx) => {
                            if (ctx.datasetIndex === 1 && overBudgetAmounts[ctx.dataIndex] > 0) {
                                return '⚠️ Over by: ₱' + overBudgetAmounts[ctx.dataIndex].toLocaleString();
                            }
                            return '';
                        }
                    }
                },
                datalabels: {
                    display: false
                }
            }
        },
        plugins: [{
            afterDatasetsDraw: (chart) => {
                const ctx = chart.ctx;
                chart.data.labels.forEach((label, index) => {
                    const overAmount = overBudgetAmounts[index];
                    if (overAmount > 0) {
                        const meta = chart.getDatasetMeta(1);
                        const bar = meta.data[index];

                        // ✅ Draw over-budget badge
                        const x = bar.x;
                        const y = bar.y - 25;

                        ctx.save();
                        ctx.fillStyle = '#ef4444';
                        ctx.strokeStyle = '#991b1b';
                        ctx.lineWidth = 2;

                        // Badge background
                        const badgeWidth = 90;
                        const badgeHeight = 20;
                        const badgeX = x - badgeWidth / 2;
                        const badgeY = y - badgeHeight / 2;

                        ctx.beginPath();
                        ctx.roundRect(badgeX, badgeY, badgeWidth, badgeHeight, 4);
                        ctx.fill();
                        ctx.stroke();

                        // Badge text
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 11px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('⚠️ +₱' + overAmount.toLocaleString(), x, y);
                        ctx.restore();
                    }
                });
            }
        }]
    });

    // Expense Pie Chart
    const pieData = @Html.Raw(ViewBag.PieChartData ?? "[]");

    const categoryIdToColor = {
        '1': '#60a5fa',
        '2': '#ef4444',
        '3': '#fbbf24',
        '4': '#a78bfa'
    };
    const unplannedColor = '#6b7280';

    const allLabels = pieData.map(e => e.Category + (e.IsPlanned ? '' : ' (Unplanned)'));
    const allData = pieData.map(e => e.Total);

    const allColors = pieData.map((e) => {
        if (!e.IsPlanned) {
            return unplannedColor;
        }
        return categoryIdToColor[e.CategoryId] || categoryIdToColor['4'];
    });

    const pieCtx = document.getElementById('expensePieGraph').getContext('2d');
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: allLabels,
            datasets: [{
                data: allData,
                backgroundColor: allColors,
                borderWidth: 2,
                borderColor: '#1e293b'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        font: { size: 11 },
                        padding: 12
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    callbacks: {
                        label: ctx => ctx.label + ': ₱' + ctx.raw.toLocaleString()
                    }
                },
                datalabels: {
                    display: false
                }
            }
        }
    });
</script>