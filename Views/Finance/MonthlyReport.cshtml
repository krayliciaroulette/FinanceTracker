@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Monthly Expense Report";
    Layout = "_FinanceLayout";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">📅 Monthly Expense Report</h2>

    <div class="card shadow-sm p-4 mb-4">
        <canvas id="monthlyChart" height="120"></canvas>
    </div>
    <div class="text-end mb-3">
        <a asp-action="ExportMonthlyReportToPdf" class="btn btn-danger">
            <i class="bi bi-file-earmark-pdf"></i> Export to PDF
        </a>
    </div>


    <div class="card shadow-sm p-3">
        <h5 class="mb-3">Detailed Monthly Summary</h5>
        <table class="table table-bordered table-hover text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Year</th>
                    <th>Month</th>
                    <th>Total Spent (₱)</th>
                    <th>Transactions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Year</td>
                            <td>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(item.Month)</td>
                            <td>₱@item.TotalExpenses.ToString("N2")</td>
                            <td>@item.Transactions</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-muted">No data available.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="text-center mt-4">
        <a asp-action="Dashboard" class="btn btn-secondary">← Back to Dashboard</a>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const monthlyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

        if (monthlyData && monthlyData.length > 0) {
            const labels = monthlyData.map(item =>
                `${item.month}/${item.year}`
            );
            const data = monthlyData.map(item => item.totalExpenses);

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Expenses (₱)',
                        data: data,
                        borderWidth: 1,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (₱)' }
                        },
                        x: {
                            title: { display: true, text: 'Month/Year' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return '₱' + context.formattedValue;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
}
